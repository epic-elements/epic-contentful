<link rel="import" href="../epic-rx/epic-rx.html">
<script>

    window.Epic = window.Epic || {Behaviors:{}};

    class EpicBehaviorObservables {

        get observables() {
          return this._observables;
        }
        set observables(value) {
          this._observables = value;
        }
        // Define other lifecycle methods as you need.
        static registered() {
            console.log('registered');


        }

        static created() {
            console.log('created');
            this.observables = Rx.DOM.fromEvent(this, 'epic-action').map(x=>x.detail);
            this._createPropertyChangeObservable(this.properties).subscribe(x=>{
                this.fire('epic-action', {
                    type: 'property-changed',
                    detail: {
                        name: x.type.replace('-changed',''),
                        value: x.detail.value
                    }
                });
            });
        }
        static ready() {
            Rx.Observable.from(Object.keys(this.properties)).map(x=>{
                let attribute = x.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
                return {
                    type: 'property-changed',
                    detail: {
                        name: attribute,
                        value: this[attribute]
                    }
                };
            })
            .subscribe(x=>{
                this.fire('epic-action',x)
            });
        }
        static attributeChanged(attribute, oldValue, newValue) {
            console.log('attributeChanged');
            this.fire('epic-action', {type: 'attribute-changed', detail:{attribute: attribute, oldValue: oldValue, newValue: newValue}});
        }

        // Behaviors

        /**
         * Creates a dom observer for `element`.
         *
         * @param {HTMLElement} element The element whose children you wish to observe.
         * @return {object} The dom observer.
         */
        static _domObservable(element){
            var boundHandler = this._childNodesChanged.bind(this);
            return Polymer.dom(element).observeNodes(boundHandler);
        }

        /**
         * Fires 'epic-action' event.
         *
         * @param {HTMLElement} element The element whose children you wish to observe.
         * @return {object} The dom observer.
         */
        static _childNodesChanged(changes){
            this.fire('epic-action', {type: 'dom-changed', detail: {changes: changes}});
        }

        // Creates event for property Changes
        static _createPropertyChangeObservable(properties){
            let propertiesArray = Object.keys(properties);
            let fromPropertyChangedEvent = this._fromPropertyChangedEvent.bind(this);
            return Rx.Observable.from(propertiesArray)
                .filter(x=>properties[x].notify===true)
                .flatMap(fromPropertyChangedEvent);
        }
        static _fromPropertyChangedEvent(property){
            let attribute = property.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
            return Rx.DOM.fromEvent(this, `${attribute}-changed`);
        }


    };
    window.Epic.Behaviors.Observables = EpicBehaviorObservables;
    // window.Epic.Observable = EpicObservable;
</script>
