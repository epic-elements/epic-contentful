<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./epic-contentful-params.html" />
<link rel="import" href="../polymer/lib/utils/debounce.html">

<dom-module id="epic-contentful">
  <template>
    <slot id="params" select="epic-contentful-params"></slot>
    <slot></slot>
  </template>

  <script src="../contentful/index.js"></script>

  <script>
    class EpicContentful extends Polymer.Element {
      static get is() { return 'epic-contentful' }

      static get properties() {
        return {
          token: {
            type: String,
            notify: true,
            value: '',
          },
          space: {
            type: String,
            notify: true,
            value: '',
          },
          host: {
            type: String,
            notify: true,
            value: ''
          },
          client: {
            type: Object,
            notify: true,
            computed: '_computeClient(disabled, token, space)'
          },
          entryId: {
            type: String,
            notify: true,
            value: ''
          },
          entry: {
            type: Object,
            notify: true,
            observer: '_entryChanged'
          },
          entries: {
            type: Array,
            notify: true,
            value: () => ({})
          },
          contentType: {
            type: String,
            notify: true,
            value: '',
            observer: '_contentTypeChanged'
          },
          contentTypeSchema: {
            type: Object,
            notify: true,
            observer: '_contentTypeSchemaChanged'
          },
          mode: {
            type: String,
            notify: true,
            value: 'entries'
          },
          searchParams: {
            type: Object,
            notify: true,
            value: function() {return {}}
          },
          /*
            Indicates "skip" value passed in contentful query. Helpful for pagination.
          */
          skip: {
            type: Number,
            notify: true,
            value: 0 // default for contentful
          },
          /*
            Indicates 'limit' value passed in contentful query. Helpful for pagination.
          */
          limit: {
            type: Number,
            notify: true,
            value: 100 // default for contentful
          },
          /*
            Indicates 'order' value passed in contenful query.
            Contentful does not specify default, seems to be arbitrary.
            Note you can prepend "-" to this to get reverse order.
          */
          orderBy: {
            type: String,
            notify: true,
            value: ''
          },
          debounceDuration: {
            type: Number,
            notify: true,
            value: 100,
          },
          disabled: {
            type: Boolean,
            notify: true,
            value: false
          }
        }
      }

      static get observers() {
        return [
          // '_getSingleEntry(client, entryId, mode)',
          // '_getContentTypeSchema(client, contentType, mode)',
          '_getEntries(disabled, client, searchParams.*, mode, debounceDuration, limit, skip, orderBy)',
        ]
      }

      // Property Observer Methods

      _getSingleEntry(client, entryId, mode) {
        if (!client || Object.keys(client).length < 1 || !entryId || mode !== 'entry') {
          this.entry = {};
        } else {
          this.debounce('getEntry', () => {
            client.getEntry(entryId)
              .then(((entry) => this.entry = entry || {}).bind(this));
          })

        }
      }

      _getEntries(disabled, client, searchParams, mode, debounceDuration, limit, skip, orderBy) {
        if (!disabled) {
          if (
            client && Object.keys(client).length > 0 &&
            searchParams.base &&
            Object.keys(searchParams.base).length > 0 &&
            mode === 'entries'
          ) {

            // modify searchParams
            searchParams.base.limit = this.limit;
            searchParams.base.skip = this.skip;
            searchParams.base.order = this.orderBy;

            //
            delete searchParams.base.value;
            delete searchParams.base.queueProperty;

            this._debouncer = Polymer.Debouncer.debounce(
              this._debouncer,
              Polymer.Async.timeOut.after(debounceDuration),
              () => {
                client.getEntries(searchParams.base)
                  .then(((entries) => {
                      this.entries = entries;
                      console.log(entries)
                    }).bind(this)
                  );
              }
            );
          }
        }
      }

      _getContentTypeSchema(client, contentType, mode) {
        if (!client || Object.keys(client).length < 1 || !contentType) {
          this.contentTypeSchema = {};
        } else {
          this.debounce('getContentType', () => {
            client.getContentType(contentType)
              .then(((contentTypeSchema) => this.contentTypeSchema = contentTypeSchema || {}).bind(this))
          });
        }
      }

      // Computed Property Methods

      _computeClient(disabled, token, space) {
        if (disabled || !token || !space) {
          return;
        } else {
          return contentful.createClient({
            space: space,
            accessToken: token
          })
        }
      }

      _contentTypeChanged(contentType) {
        this.searchParams = Object.assign({}, this.searchParams, {
          content_type: contentType
        });
      }

      _computeConfig(property, value){
          var obj = {};
          if(!property || !value){
              return obj;
          } else {
              obj[property] = value;
              return obj;
          }
      }

      // Event Handlers

      _handleConfigChange(event) {
        this.searchParams = Object.assign(
          {},
          this.searchParams,
          event.detail
        );
      }

      // Lifecycle callbacks

      ready() {
        super.ready();

        this.shadowRoot
          .querySelector('#params')
          .assignedNodes({flatten:true})
          .filter(n => n.nodeType === Node.ELEMENT_NODE)
          .forEach((node) => {

            this.searchParams = Object.assign(this.searchParams, node.config)

            node.addEventListener('config-changed', this._handleConfigChange.bind(this));
          });
      }
    };

    window.customElements.define(EpicContentful.is, EpicContentful);
  </script>
</dom-module>
