<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../epic-polyfills/epic-polyfills.html">
<link rel="import" href="contentful.html">
<link rel="import" href="epic-contentful-params.es6.html">

<dom-module id="epic-contentful">
  <template>
        <content id="params" select="epic-contentful-params"></content>
        <content></content>
  </template>

  <script>
  (function() {
    'use strict';

    class EpicContentful {

      beforeRegister() {
        this.is = 'epic-contentful';

        this.properties = {
            token: {
              type: String,
              notify: true,
              value: '',
              observer: '_tokenChanged'
          },
            space: {
              type: String,
              notify: true,
              value: '',
              observer: '_spaceChanged'
          },
          host:{
              type: String,
              notify: true,
              value: '',
              observer: '_hostChanged'
          },
          client:{
            type:Object,
            notify: true,
            computed: '_computeClient(token, space)'
          },
          entryId: {
              type: String,
              notify: true,
              value: '',
              observer: '_entryIdChanged'
          },
          entry: {
              type: Object,
              notify: true,
              value: ()=>({}),
              observer: '_entryChanged'
          },
          entries: {
            type: Array,
            notify: true,
            value:()=>({}),
            observer: '_entriesChanged'
          },
          contentType:{
              type: String,
              notify: true,
              value: '',
              observer: '_contentTypeChanged'
          },
          contentTypeSchema:{
              type: Object,
              notify: true,
              observer: '_contentTypeSchemaChanged'
          },
          mode:{
              type: String,
              notify: true,
              value: 'entries'
          },
        searchParamNodes:{
                type: Array,
                notify: true,
                value:()=>[],
                observer: '_searchParamNodesChanged'
        },
          searchParams: {
              type: Object,
              notify: true,
              computed: '_computeSearchParams(contentType, searchParamNodes)',
              observer: '_searchParamsChanged'
          }
        };

        this.observers = [
            '_getSingleEntry(client, entryId, mode)',
            '_getContentTypeSchema(client, contentType, mode)',
            '_getEntries(client, searchParams, mode)',
        ];
      }

      // Property Observer Methods

        _tokenChanged(token){
            console.log('_tokenChanged', token);
        }
        _spaceChanged(space){
            console.log('_spaceChanged', space);
        }
        _entryIdChanged(entryId){
            console.log('_entryIdChanged', entryId);
        }
        _entryChanged(entry){
            console.log('_entryChanged', entry);
        }

        _entriesChanged(entries){
            console.log('_entries', entries);
        }

        _contentTypeChanged(contentType){
            console.log('_contentTypeChanged', contentType);
        }
        _contentTypeSchemaChanged(contentTypeSchema){
            console.log('_contentTypeSchemaChanged', contentTypeSchema);
        }

        _searchParamNodesChanged(searchParamNodes){
            console.log('_searchParamNodesChanged');
            console.log(searchParamNodes);
        }

        _searchParamsChanged(searchParams){
            console.log('_searchParamsChanged');
            console.log(searchParams);
        }

        _getSingleEntry(client, entryId, mode){
            if(!client || Object.keys(client).length < 1 || !entryId || mode !== 'entry'){
                this.entry = {};
            } else {
                this.debounce('getEntry', ()=>{
                    client.getEntry(entryId)
                        .then(((entry) => this.entry = entry || {}).bind(this));
                })

            }
        }

        _getEntries(client, searchParams, mode){
            if(!client || Object.keys(client).length < 1 || !searchParams || Object.keys(searchParams).length < 1 || mode !== 'entries'){
                this.entries = {};
            } else {
                this.debounce('getEntries', ()=>{
                    client.getEntries(searchParams)
                        .then((entries => this.entries = entries || {}).bind(this));
                });
            }
        }

        _getContentTypeSchema(client, contentType, mode){
            if(!client || Object.keys(client).length < 1 || !contentType || mode !== 'contentType'){
                this.contentTypeSchema = {};
            } else {
                this.debounce('getContentType', ()=>{
                    client.getContentType(contentType)
                        .then(((contentTypeSchema)=>this.contentTypeSchema = contentTypeSchema || {}).bind(this))
                });
            }
        }

      // Computed Property Methods

      _computeClient(token, space){
          if(!token || !space){
              return {};
          } else {
              return contentful.createClient({
                  space: space,
                  accessToken: token
                })
          }
      }

      _computeSearchParams(contentType, searchParamNodes){
          if(!contentType){
              return {};
          } else if(!contentType && (!searchParamNodes || searchParamNodes.length < 1)){
              return {};
          } else if (contentType && (!searchParamNodes || searchParamNodes.length < 1)){
              return {content_type: contentType};
          } else {
              return searchParamNodes.reduce((previous, current)=>{
                  let obj = {};
                  obj[current.property] = current.value;
                  return Object.assign({}, previous, obj);
              }, {content_type: contentType});
          }
      }

    // Lifecycle callbacks
      created(){}
      registered(){}
      ready(){}
      attached(){
         this.searchParamNodes = this.getContentChildren('#params');
      }
      attributeChanged(){}

    }
    // Register the element using Polymer's constructor.
    Polymer(EpicContentful);
  })();
  </script>
</dom-module>
