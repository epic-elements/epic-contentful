<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="contentful.html">
<link rel="import" href="epic-contentful-filter.html">

<dom-module id="epic-contentful">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
        auto
        url="[[url]]"
        handle-as="json"
        on-response="handleResponse"
        debounce-duration="300"></iron-ajax>
        <content id="filters" select="epic-contentful-filter"></content>
        <content></content>
  </template>

  <script>
  (function() {
    'use strict';

    class EpicContentful {

      beforeRegister() {
        this.is = 'epic-contentful';

        this.properties = {
            token: {
              type: String,
              notify: true,
              value: '',
              observer: '_tokenChanged'
          },
            space: {
              type: String,
              notify: true,
              value: '',
              observer: '_spaceChanged'
          },
          client:{
            type:Object,
            notify: true,
            computed: '_computeClient(token, space)'
          },
          entryId: {
              type: String,
              notify: true,
              value: '',
              observer: '_entryIdChanged'
          },
          entry: {
              type: Object,
              notify: true,
              value: ()=>({}),
              observer: '_entryChanged'
          },
          contentType:{
              type: String,
              notify: true,
              value: '',
              observer: '_contentTypeChanged'
          },
          contentTypeSchema:{
              type: Object,
              notify: true,
              observer: '_contentTypeSchemaChanged'
          },
          contentTypeQueryParam:{
              type: String,
              notify: true,
              value:'',
              computed: '_computeContentTypeQueryParam(contentType)'
          },
          resourceType:{
              type: String,
              notify: true,
              value: 'entries'
          },
          url:{
              type: String,
              notify: true,
              computed: '_computeBaseURL(token,space,resourceType,contentTypeQueryParam, searchQueryString)'
        },
          response: {
              type: Object,
              notify: true,
              value: ()=>({}),
              observer: '_responseChanged'
          },
          searchParams: {
              type: Array,
              notify: true,
              value: ()=>[],
          },
          searchQueryString: {
              type: String,
              notify: true,
              value: '',
              computed: '_computesearchQueryParams(searchParams, searchParams.*)',
              observer: '_searchQueryStringChanged'
          }
        };

        this.observers = [
            '_getSingleEntry(client, entryId)',
            '_getContentTypeSchema(client, contentType)',
        ];
      }

      // Property Observer Methods

        _tokenChanged(token){
            console.log('_tokenChanged', token);
        }
        _spaceChanged(space){
            console.log('_spaceChanged', space);
        }
        _entryIdChanged(entryId){
            console.log('_entryIdChanged', entryId);
        }
        _entryChanged(entry){
            console.log('_entryChanged', entry);
        }
        _contentTypeChanged(contentType){
            console.log('_contentTypeChanged', contentType);
        }
        _contentTypeSchemaChanged(contentTypeSchema){
            console.log('_contentTypeSchemaChanged', contentTypeSchema);
        }

        _getSingleEntry(client, entryId){
            if(!client || Object.keys(client).length < 1 || !entryId){
                this.entry = {};
            } else {
                this.debounce('getEntry', ()=>{
                    client.getEntry(entryId)
                        .then(((entry) => this.entry = entry || {}).bind(this));
                })

            }
        }

        _getContentTypeSchema(client, contentType){
            if(!client || Object.keys(client).length < 1 || !contentType){
                this.contentTypeSchema = {};
            } else {
                this.debounce('getContentType', ()=>{
                    client.getContentType(contentType)
                        .then(((contentTypeSchema)=>this.contentTypeSchema = contentTypeSchema || {}).bind(this))
                });
            }
        }

      // Computed Property Methods

      _computeClient(token, space){
          if(!token || !space){
              return {};
          } else {
              return contentful.createClient({
                  space: space,
                  accessToken: token
                })
          }

      }

      _searchQueryStringChanged(value){

      }

      _computesearchQueryParams(searchParams){
          let uniques = Array.from(new Set(searchParams));
          return searchParams.reduce((x1,x2)=>`${x1}${x2}`,'');
      }

      _responseChanged(newValue, oldValue){
          this.fire('response', {value: newValue});
      }

      _computeContentTypeQueryParam(contentType){
          if (contentType){
              return `&content_type=${contentType}`;
          }
          return '';
      }

      _computeBaseURL(token,space,resourceType,contentTypeQueryParam,searchQueryString) {
          if(!token || !space || !resourceType)
            return '';

            return `https://cdn.contentful.com/spaces/${space}/${resourceType}?access_token=${token}${contentTypeQueryParam}${searchQueryString}`
        }

    // Lifecycle callbacks
      created(){}
      registered(){}
      ready(){}
      attached(){}
      attributeChanged(){}

    }
    // Register the element using Polymer's constructor.
    Polymer(EpicContentful);
  })();
  </script>
</dom-module>
